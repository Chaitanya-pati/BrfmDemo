{% extends "base.html" %}

{% block title %}Live Production Monitor{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-tv me-2"></i>Live Production Monitor
                            <span class="badge bg-success ms-2">LIVE</span>
                        </h4>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshData()">
                                <i class="fas fa-sync-alt me-1"></i>Refresh
                            </button>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                <label class="form-check-label" for="autoRefresh">Auto: ON</label>
                            </div>
                            <a href="{{ url_for('production_dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Production Pipeline Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list-ol me-2"></i>Production Pipeline Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center" id="pipeline-status">
                        <!-- Pipeline stages will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Production Jobs with Timers -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>Active Production Jobs
                        <span class="badge bg-primary" id="active-jobs-count">0</span>
                    </h5>
                </div>
                <div class="card-body" id="active-jobs-container">
                    <!-- Active jobs will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Machine Cleaning Reminders -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning" id="cleaning-reminders-card" style="display: none;">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-bell me-2"></i>Machine Cleaning Reminders
                        <span class="badge bg-danger" id="cleaning-reminders-count">0</span>
                    </h5>
                </div>
                <div class="card-body" id="cleaning-reminders-container">
                    <!-- Cleaning reminders will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Machine Cleaning Alerts -->
    <div class="col-12">
        <div class="card border-warning" id="cleaning-alerts-card" style="display: none;">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Machine Cleaning Required
                    <span class="badge bg-danger" id="cleaning-alerts-count">0</span>
                </h5>
            </div>
            <div class="card-body" id="cleaning-alerts-container">
                <!-- Cleaning alerts will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Machine Cleaning Modal -->
<div class="modal fade" id="cleaningModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Machine Cleaning Required</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cleaningForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Machine Name</label>
                                <input type="text" id="machine-name" class="form-control" readonly>
                                <input type="hidden" id="job-id">
                                <input type="hidden" id="process-type">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cleaned By *</label>
                                <input type="text" id="cleaned-by" class="form-control" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Photo Before Cleaning *</label>
                                <input type="file" id="photo-before" class="form-control" accept="image/*" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Photo After Cleaning *</label>
                                <input type="file" id="photo-after" class="form-control" accept="image/*" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Waste Collected (kg)</label>
                                <input type="number" id="waste-collected" class="form-control" step="0.1" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea id="cleaning-notes" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitCleaning()">
                    <i class="fas fa-check me-1"></i>Complete Cleaning
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let refreshInterval;
let timerInterval;
let cleaningReminders = {};

// Start auto-refresh and timers
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    startAutoRefresh();
    startTimers();

    // Request notification permission
    if (Notification.permission === "default") {
        Notification.requestPermission();
    }
});

function startAutoRefresh() {
    const autoRefreshCheckbox = document.getElementById('autoRefresh');

    if (autoRefreshCheckbox.checked) {
        refreshInterval = setInterval(loadData, 5000); // Refresh every 5 seconds
    }

    autoRefreshCheckbox.addEventListener('change', function() {
        if (this.checked) {
            refreshInterval = setInterval(loadData, 5000);
            document.querySelector('.form-check-label').textContent = 'Auto: ON';
        } else {
            clearInterval(refreshInterval);
            document.querySelector('.form-check-label').textContent = 'Auto: OFF';
        }
    });
}

function startTimers() {
    // Update timers every second
    timerInterval = setInterval(updateTimers, 1000);
}

function loadData() {
    // Load pipeline status
    fetch('/api/production_pipeline_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePipelineStatus(data.pipeline);
            }
        })
        .catch(error => console.error('Error loading pipeline status:', error));

    // Load active jobs
    fetch('/api/production_jobs_by_stage')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateActiveJobs(data.data);
            }
        })
        .catch(error => console.error('Error loading active jobs:', error));

    // Load cleaning alerts
    fetch('/api/cleaning_alerts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateCleaningAlerts(data.alerts);
            }
        })
        .catch(error => console.error('Error loading cleaning alerts:', error));
    
    // Load cleaning reminders
    updateCleaningReminders();
}

function updatePipelineStatus(pipeline) {
    const container = document.getElementById('pipeline-status');
    const stages = ['transfer', 'cleaning_24h', 'cleaning_12h', 'grinding', 'packing'];
    const stageNames = ['Transfer', '24H Cleaning', '12H Cleaning', 'Grinding', 'Packing'];
    const stageIcons = ['fas fa-exchange-alt', 'fas fa-clock', 'fas fa-hourglass-half', 'fas fa-cogs', 'fas fa-box'];

    let html = '';

    stages.forEach((stage, index) => {
        const stageData = pipeline[stage] || { active: 0, total: 0 };
        const isActive = stageData.active > 0;
        const cardClass = isActive ? 'bg-success text-white' : 'bg-secondary text-white';

        html += `
            <div class="col-md-2">
                <div class="card ${cardClass} mb-2">
                    <div class="card-body text-center p-2">
                        <div class="mb-1">
                            <i class="${stageIcons[index]} fa-2x"></i>
                        </div>
                        <h6 class="mb-1">${stageNames[index]}</h6>
                        <small>Active: ${stageData.active}</small><br>
                        <small>Total: ${stageData.total}</small>
                    </div>
                </div>
            </div>
        `;

        // Add arrow between stages (except last)
        if (index < stages.length - 1) {
            html += `
                <div class="col-auto d-flex align-items-center">
                    <i class="fas fa-arrow-right fa-2x text-muted"></i>
                </div>
            `;
        }
    });

    container.innerHTML = html;
}

function updateActiveJobs(jobsData) {
    const container = document.getElementById('active-jobs-container');
    const countBadge = document.getElementById('active-jobs-count');

    let totalJobs = 0;
    let html = '';

    Object.keys(jobsData).forEach(stage => {
        const jobs = jobsData[stage];
        totalJobs += jobs.length;

        jobs.forEach(job => {
            const progressBarClass = job.status === 'in_progress' ? 'bg-success' : 'bg-warning';
            const statusBadge = job.status === 'in_progress' ? 'bg-success' : 'bg-warning';
            
            // Calculate countdown for cleaning processes
            let countdownHtml = '';
            if (job.stage.includes('cleaning') && job.status === 'in_progress') {
                const duration = job.stage === 'cleaning_24h' ? 24 : 12;
                countdownHtml = `
                    <div class="countdown-timer mt-2 p-2 bg-light rounded" data-job-id="${job.id}" data-duration="${duration}">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="fw-bold">Time Remaining:</small>
                            <span class="badge bg-primary countdown-display" id="countdown-${job.id}">--:--:--</span>
                        </div>
                        <div class="progress mt-1" style="height: 6px;">
                            <div class="progress-bar bg-primary countdown-progress" id="countdown-progress-${job.id}" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                `;
            }

            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card border-primary">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">${job.job_number}</h6>
                            <span class="badge ${statusBadge}">${job.status.toUpperCase()}</span>
                        </div>
                        <div class="card-body">
                            <p class="mb-1"><strong>Order:</strong> ${job.order_number}</p>
                            <p class="mb-1"><strong>Stage:</strong> ${job.stage.replace('_', ' ').toUpperCase()}</p>
                            <p class="mb-2"><strong>Operator:</strong> ${job.started_by || 'Not assigned'}</p>

                            <div class="progress mb-2">
                                <div class="progress-bar ${progressBarClass}" role="progressbar" 
                                     style="width: ${job.progress}%" aria-valuenow="${job.progress}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    ${job.progress}%
                                </div>
                            </div>

                            ${countdownHtml}

                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">
                                    Started: ${job.started_at || 'Not started'}
                                </small>
                                <div class="timer-display" data-job-id="${job.id}" data-stage="${job.stage}">
                                    <span class="badge bg-info" id="timer-${job.id}">--:--:--</span>
                                </div>
                            </div>

                            <!-- Machine Cleaning Alert -->
                            <div class="cleaning-alert mt-2" id="cleaning-alert-${job.id}" style="display: none;">
                                <div class="alert alert-warning alert-sm py-1 px-2 mb-2">
                                    <i class="fas fa-tools me-1"></i>
                                    <small class="fw-bold">Machine cleaning required!</small>
                                    <button class="btn btn-xs btn-warning ms-2" onclick="startMachineCleaning(${job.id}, '${job.stage}')">
                                        Clean Now
                                    </button>
                                </div>
                            </div>

                            ${job.status === 'in_progress' && job.stage === 'grinding' ? `
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-warning me-1" onclick="startGrinding(${job.id})">
                                        <i class="fas fa-play me-1"></i>Start Grinding
                                    </button>
                                    <button class="btn btn-sm btn-warning me-1" onclick="pauseJob(${job.id})">
                                        <i class="fas fa-pause"></i> Pause
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="completeJob(${job.id})">
                                        <i class="fas fa-check"></i> Complete
                                    </button>
                                </div>
                            ` : (job.status === 'in_progress' ? `
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-warning me-1" onclick="pauseJob(${job.id})">
                                        <i class="fas fa-pause"></i> Pause
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="completeJob(${job.id})">
                                        <i class="fas fa-check"></i> Complete
                                    </button>
                                </div>
                            ` : '')}
                        </div>
                    </div>
                </div>
            `;
        });
    });

    if (totalJobs === 0) {
        html = '<div class="text-center text-muted"><i class="fas fa-info-circle me-2"></i>No active production jobs</div>';
    }

    container.innerHTML = html;
    countBadge.textContent = totalJobs;
    
    // Initialize countdown timers
    initializeCountdownTimers();
}

function updateTimers() {
    // Update job timers
    document.querySelectorAll('.timer-display').forEach(timerElement => {
        const jobId = timerElement.getAttribute('data-job-id');
        const stage = timerElement.getAttribute('data-stage');

        fetch(`/api/job_timer/${jobId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const timerSpan = document.getElementById(`timer-${jobId}`);
                    if (timerSpan) {
                        timerSpan.textContent = data.elapsed_time;

                        // Check for cleaning reminders
                        if (data.cleaning_reminder) {
                            checkCleaningReminder(jobId, stage, data.cleaning_reminder);
                        }
                    }
                }
            })
            .catch(error => console.error('Error updating timer:', error));
    });
    
    // Update countdown timers
    updateCountdownTimers();
}

function initializeCountdownTimers() {
    document.querySelectorAll('.countdown-timer').forEach(timer => {
        const jobId = timer.getAttribute('data-job-id');
        const duration = parseInt(timer.getAttribute('data-duration'));
        
        // Fetch job start time and calculate countdown
        fetch(`/api/job_timer/${jobId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.start_time) {
                    const startTime = new Date(data.start_time);
                    const endTime = new Date(startTime.getTime() + (duration * 60 * 60 * 1000));
                    timer.setAttribute('data-end-time', endTime.toISOString());
                }
            })
            .catch(error => console.error('Error initializing countdown:', error));
    });
}

function updateCountdownTimers() {
    document.querySelectorAll('.countdown-timer').forEach(timer => {
        const endTimeStr = timer.getAttribute('data-end-time');
        if (!endTimeStr) return;
        
        const jobId = timer.getAttribute('data-job-id');
        const endTime = new Date(endTimeStr);
        const now = new Date();
        const remaining = endTime - now;
        
        const countdownDisplay = document.getElementById(`countdown-${jobId}`);
        const countdownProgress = document.getElementById(`countdown-progress-${jobId}`);
        
        if (remaining > 0) {
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            countdownDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Calculate progress percentage
            const duration = parseInt(timer.getAttribute('data-duration'));
            const totalMs = duration * 60 * 60 * 1000;
            const elapsedMs = totalMs - remaining;
            const progressPercent = Math.min(100, Math.max(0, (elapsedMs / totalMs) * 100));
            
            countdownProgress.style.width = `${progressPercent}%`;
            
            // Change color based on remaining time
            if (remaining < 3600000) { // Less than 1 hour
                countdownDisplay.className = 'badge bg-danger countdown-display';
                countdownProgress.className = 'progress-bar bg-danger countdown-progress';
            } else if (remaining < 7200000) { // Less than 2 hours
                countdownDisplay.className = 'badge bg-warning countdown-display';
                countdownProgress.className = 'progress-bar bg-warning countdown-progress';
            } else {
                countdownDisplay.className = 'badge bg-primary countdown-display';
                countdownProgress.className = 'progress-bar bg-primary countdown-progress';
            }
        } else {
            countdownDisplay.textContent = 'COMPLETED';
            countdownDisplay.className = 'badge bg-success countdown-display';
            countdownProgress.style.width = '100%';
            countdownProgress.className = 'progress-bar bg-success countdown-progress';
        }
    });
}

function updateCleaningReminders() {
    fetch('/api/cleaning_reminders')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('cleaning-reminders-container');
                const card = document.getElementById('cleaning-reminders-card');
                const count = document.getElementById('cleaning-reminders-count');
                
                if (data.reminders.length === 0) {
                    card.style.display = 'none';
                    return;
                }
                
                let html = '';
                data.reminders.forEach(reminder => {
                    const urgencyClass = reminder.urgent ? 'danger' : 'warning';
                    const urgencyIcon = reminder.urgent ? 'exclamation-triangle' : 'clock';
                    
                    html += `
                        <div class="alert alert-${urgencyClass} d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-${urgencyIcon} me-2"></i>
                                <strong>${reminder.machine_name}</strong>
                                <br><small>Job: ${reminder.job_number} | Stage: ${reminder.stage}</small>
                                <br><small class="text-muted">Next cleaning due: ${reminder.next_cleaning_time}</small>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="startMachineCleaning(${reminder.job_id}, '${reminder.stage}')">
                                <i class="fas fa-tools me-1"></i>Clean Now
                            </button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                card.style.display = 'block';
                count.textContent = data.reminders.length;
                
                // Show individual job cleaning alerts
                data.reminders.forEach(reminder => {
                    const jobAlert = document.getElementById(`cleaning-alert-${reminder.job_id}`);
                    if (jobAlert) {
                        jobAlert.style.display = 'block';
                    }
                });
            }
        })
        .catch(error => console.error('Error loading cleaning reminders:', error));
}

function checkCleaningReminder(jobId, stage, reminderData) {
    const reminderKey = `${jobId}-${reminderData.reminder_count}`;

    // Only show each reminder once
    if (!cleaningReminders[reminderKey] && reminderData.should_show) {
        cleaningReminders[reminderKey] = true;

        // Show notification
        if (Notification.permission === "granted") {
            new Notification("Machine Cleaning Required", {
                body: `${stage.replace('_', ' ').toUpperCase()} process requires machine cleaning`,
                icon: "/static/favicon.ico"
            });
        }

        // Add to cleaning alerts
        addCleaningAlert(jobId, stage, reminderData);
    }
}

function addCleaningAlert(jobId, stage, reminderData) {
    const alertsContainer = document.getElementById('cleaning-alerts-container');
    const alertsCard = document.getElementById('cleaning-alerts-card');
    const alertsCount = document.getElementById('cleaning-alerts-count');

    const alertHtml = `
        <div class="alert alert-warning alert-dismissible fade show" id="alert-${jobId}-${reminderData.reminder_count}">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong><i class="fas fa-wrench me-2"></i>Machine Cleaning Required</strong><br>
                    <small>Job: ${jobId} | Stage: ${stage.replace('_', ' ').toUpperCase()}</small>
                </div>
                <button class="btn btn-sm btn-primary" onclick="startMachineCleaning(${jobId}, '${stage}')">
                    <i class="fas fa-tools me-1"></i>Start Cleaning
                </button>
            </div>
        </div>
    `;

    alertsContainer.insertAdjacentHTML('beforeend', alertHtml);
    alertsCard.style.display = 'block';

    // Update count
    const currentCount = parseInt(alertsCount.textContent) || 0;
    alertsCount.textContent = currentCount + 1;
}

function updateCleaningAlerts(alerts) {
    const container = document.getElementById('cleaning-alerts-container');
    const card = document.getElementById('cleaning-alerts-card');
    const count = document.getElementById('cleaning-alerts-count');

    if (alerts.length === 0) {
        card.style.display = 'none';
        return;
    }

    let html = '';
    alerts.forEach(alert => {
        html += `
            <div class="alert alert-warning d-flex justify-content-between align-items-center">
                <div>
                    <strong><i class="fas fa-wrench me-2"></i>${alert.machine_name}</strong><br>
                    <small>Job: ${alert.job_number} | Stage: ${alert.stage}</small><br>
                    <small class="text-muted">Due: ${alert.due_time}</small>
                </div>
                <button class="btn btn-sm btn-primary" onclick="startMachineCleaning(${alert.job_id}, '${alert.stage}')">
                    <i class="fas fa-tools me-1"></i>Start Cleaning
                </button>
            </div>
        `;
    });

    container.innerHTML = html;
    card.style.display = 'block';
    count.textContent = alerts.length;
}

function startMachineCleaning(jobId, stage) {
    // Open cleaning modal
    document.getElementById('job-id').value = jobId;
    document.getElementById('process-type').value = stage;
    document.getElementById('machine-name').value = `${stage.replace('_', ' ').toUpperCase()} Machine`;

    const modal = new bootstrap.Modal(document.getElementById('cleaningModal'));
    modal.show();
}

function submitCleaning() {
    const form = document.getElementById('cleaningForm');
    const formData = new FormData();

    formData.append('job_id', document.getElementById('job-id').value);
    formData.append('process_type', document.getElementById('process-type').value);
    formData.append('cleaned_by', document.getElementById('cleaned-by').value);
    formData.append('waste_collected', document.getElementById('waste-collected').value || '0');
    formData.append('notes', document.getElementById('cleaning-notes').value);
    formData.append('photo_before', document.getElementById('photo-before').files[0]);
    formData.append('photo_after', document.getElementById('photo-after').files[0]);

    fetch('/api/submit_machine_cleaning', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('cleaningModal')).hide();

            // Reset form
            form.reset();

            // Show success message
            showToast('Machine cleaning completed successfully!', 'success');

            // Refresh data
            loadData();
        } else {
            showToast('Error completing machine cleaning: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error submitting cleaning:', error);
        showToast('Error submitting cleaning data', 'error');
    });
}

function pauseJob(jobId) {
    fetch(`/api/job_control/${jobId}/pause`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ operator_name: 'Live Monitor' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            loadData();
        } else {
            showToast('Error: ' + data.message, 'error');
        }
    })
    .catch(error => console.error('Error pausing job:', error));
}

function completeJob(jobId) {
    if (confirm('Are you sure you want to complete this job?')) {
        fetch(`/api/job_control/${jobId}/complete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                operator_name: 'Live Monitor',
                auto_move_next: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                loadData();
            } else {
                showToast('Error: ' + data.message, 'error');
            }
        })
        .catch(error => console.error('Error completing job:', error));
    }
}

function refreshData() {
    showToast('Refreshing data...', 'info');
    loadData();
}

function showToast(message, type) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Cleanup intervals when page is closed
window.addEventListener('beforeunload', function() {
    if (refreshInterval) clearInterval(refreshInterval);
    if (timerInterval) clearInterval(timerInterval);
});

function startGrinding(jobId) {
    // Use API endpoint to start grinding
    fetch(`/api/start_grinding/${jobId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                showToast(data.message, 'success');
                loadData();
            }
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to start grinding process', 'error');
    });
}
</script>
{% endblock %}