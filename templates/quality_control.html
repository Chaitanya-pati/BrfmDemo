{% extends "base.html" %}

{% block title %}Quality Control - Wheat Processing Management{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-microscope me-2"></i>Quality Control & Testing
                        </h4>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="location.reload()">
                                <i class="fas fa-refresh me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Quality Test Form -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-flask me-2"></i>Conduct Quality Test
                    </h5>
                </div>
                <div class="card-body">
                    {% if vehicles %}
                    <form method="POST" enctype="multipart/form-data" id="qualityTestForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicle_id" class="form-label">Select Vehicle *</label>
                                    <select class="form-select" id="vehicle_id" name="vehicle_id" required onchange="loadVehicleInfo()">
                                        <option value="">Choose vehicle for testing</option>
                                        {% for vehicle in vehicles %}
                                        <option value="{{ vehicle.id }}" 
                                                data-number="{{ vehicle.vehicle_number }}" 
                                                data-supplier="{{ vehicle.supplier.company_name if vehicle.supplier else 'Unknown' }}">
                                            {{ vehicle.vehicle_number }} - {{ vehicle.supplier.company_name if vehicle.supplier else 'Unknown Supplier' }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lab_instructor" class="form-label">Lab Instructor *</label>
                                    <input type="text" class="form-control" id="lab_instructor" name="lab_instructor" 
                                           placeholder="Name of lab instructor" required>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicle Info Display -->
                        <div class="row" id="vehicleInfoSection" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-1"></i>Vehicle Information</h6>
                                    <div id="vehicleInfoContent"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="sample_bags_tested" class="form-label">Sample Bags Tested *</label>
                                    <input type="number" class="form-control" id="sample_bags_tested" name="sample_bags_tested" 
                                           placeholder="Number of bags tested" required min="1" max="50">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="total_bags" class="form-label">Total Bags *</label>
                                    <input type="number" class="form-control" id="total_bags" name="total_bags" 
                                           placeholder="Total bags in vehicle" required min="1">
                                </div>
                            </div>
                            
                        </div>

                        <!-- Lab Testing Parameters Section -->
                        <div class="card border-info mb-4">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-flask me-1"></i>Lab Testing Parameters
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="moisture_content" class="form-label">Moisture Content (%)</label>
                                            <input type="number" class="form-control" id="moisture_content" name="moisture_content" 
                                                   placeholder="e.g., 12.5" step="0.01" min="0" max="25">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="foreign_matter" class="form-label">Foreign Matter (%)</label>
                                            <input type="number" class="form-control" id="foreign_matter" name="foreign_matter" 
                                                   placeholder="e.g., 1.2" step="0.01" min="0" max="10">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="broken_grains" class="form-label">Broken Grains (%)</label>
                                            <input type="number" class="form-control" id="broken_grains" name="broken_grains" 
                                                   placeholder="e.g., 2.5" step="0.01" min="0" max="10">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="shrivelled_broken" class="form-label">Shrivelled & Broken (%)</label>
                                            <input type="number" class="form-control" id="shrivelled_broken" name="shrivelled_broken" 
                                                   placeholder="e.g., 3.0" step="0.01" min="0" max="10">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="damaged" class="form-label">Damaged (%)</label>
                                            <input type="number" class="form-control" id="damaged" name="damaged" 
                                                   placeholder="e.g., 1.0" step="0.01" min="0" max="10">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="weevilled" class="form-label">Weevilled (%)</label>
                                            <input type="number" class="form-control" id="weevilled" name="weevilled" 
                                                   placeholder="e.g., 0.5" step="0.01" min="0" max="5">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="other_food_grains" class="form-label">Other Food Grains (%)</label>
                                            <input type="number" class="form-control" id="other_food_grains" name="other_food_grains" 
                                                   placeholder="e.g., 0.2" step="0.01" min="0" max="5">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="sprouted" class="form-label">Sprouted (%)</label>
                                            <input type="number" class="form-control" id="sprouted" name="sprouted" 
                                                   placeholder="e.g., 0.1" step="0.01" min="0" max="5">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="immature" class="form-label">Immature (%)</label>
                                            <input type="number" class="form-control" id="immature" name="immature" 
                                                   placeholder="e.g., 0.3" step="0.01" min="0" max="5">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="test_weight" class="form-label">Test Weight (kg/hl)</label>
                                            <input type="number" class="form-control" id="test_weight" name="test_weight" 
                                                   placeholder="e.g., 78.5" step="0.1" min="70" max="85">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="gluten" class="form-label">Gluten (%)</label>
                                            <input type="number" class="form-control" id="gluten" name="gluten" 
                                                   placeholder="e.g., 28.5" step="0.1" min="0" max="50">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="protein" class="form-label">Protein (%)</label>
                                            <input type="number" class="form-control" id="protein" name="protein" 
                                                   placeholder="e.g., 11.5" step="0.1" min="8" max="18">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="falling_number" class="form-label">Falling Number (sec)</label>
                                            <input type="number" class="form-control" id="falling_number" name="falling_number" 
                                                   placeholder="e.g., 350" step="1" min="200" max="500">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="ash_content" class="form-label">Ash Content (%)</label>
                                            <input type="number" class="form-control" id="ash_content" name="ash_content" 
                                                   placeholder="e.g., 1.45" step="0.01" min="0" max="3">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="wet_gluten" class="form-label">Wet Gluten (%)</label>
                                            <input type="number" class="form-control" id="wet_gluten" name="wet_gluten" 
                                                   placeholder="e.g., 28.0" step="0.1" min="0" max="50">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="dry_gluten" class="form-label">Dry Gluten (%)</label>
                                            <input type="number" class="form-control" id="dry_gluten" name="dry_gluten" 
                                                   placeholder="e.g., 10.5" step="0.1" min="0" max="20">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="sedimentation_value" class="form-label">Sedimentation Value (ml)</label>
                                            <input type="number" class="form-control" id="sedimentation_value" name="sedimentation_value" 
                                                   placeholder="e.g., 35" step="0.5" min="10" max="80">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="category_assigned" class="form-label">Quality Category *</label>
                                    <select class="form-select" id="category_assigned" name="category_assigned" required>
                                        <option value="">Assign quality category</option>
                                        <option value="Mill">Mill Grade (Premium)</option>
                                        <option value="Low Mill">Low Mill Grade</option>
                                        <option value="HD">Heavy Density (HD)</option>
                                        <option value="Rejected">Rejected</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="test_date" class="form-label">Test Date & Time</label>
                                    <input type="datetime-local" class="form-control" id="test_date" name="test_date">
                                </div>
                            </div>
                        </div>

                        <!-- Sample Photos Section -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label">Sample Photos (Before)</label>
                                    <div id="sampleBeforeContainer" class="camera-container" 
                                         data-camera-input="sample_photos_before" data-multiple="true">
                                        <div class="text-muted">
                                            <i class="fas fa-camera fa-2x mb-2"></i>
                                            <p>Capture sample photos before testing</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label">Sample Photos (After)</label>
                                    <div id="sampleAfterContainer" class="camera-container" 
                                         data-camera-input="sample_photos_after" data-multiple="true">
                                        <div class="text-muted">
                                            <i class="fas fa-camera fa-2x mb-2"></i>
                                            <p>Capture sample photos after testing</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="quality_notes" class="form-label">Quality Test Notes</label>
                                    <textarea class="form-control" id="quality_notes" name="quality_notes" rows="4" 
                                              placeholder="Detailed observations about wheat quality, impurities, color, texture, etc."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Approval Section -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-check-circle me-1"></i>Final Approval
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="approved" name="approved">
                                            <label class="form-check-label" for="approved">
                                                <strong>Approve this vehicle for unloading</strong>
                                                <br><small class="text-muted">Check only if quality meets standards</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-1"></i>Reset Form
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Record Quality Test
                            </button>
                        </div>
                    </form>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5>No Vehicles Available for Testing</h5>
                        <p class="text-muted">All vehicles have been processed or no vehicles are pending quality check.</p>
                        <a href="{{ url_for('vehicle_entry') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>Add New Vehicle
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Quality Tests -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Tests
                    </h5>
                </div>
                <div class="card-body">
                    {% if quality_tests %}
                        <div class="list-group list-group-flush">
                            {% for test in quality_tests[:10] %}
                            <div class="list-group-item border-0 px-0">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ test.vehicle.vehicle_number }}</h6>
                                        <p class="mb-1 text-muted small">
                                            {{ test.lab_instructor }}
                                        </p>
                                        <small class="text-muted">
                                            {{ test.test_time.strftime('%d/%m/%Y %H:%M') }}
                                        </small>
                                    </div>
                                    <span class="badge bg-{{ 'success' if test.approved else 'warning' if test.category_assigned != 'Rejected' else 'danger' }}">
                                        {{ test.category_assigned }}
                                    </span>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-vials me-1"></i>{{ test.sample_bags_tested }}/{{ test.total_bags }} bags
                                        {% if test.moisture_content %}
                                            <i class="fas fa-tint ms-2 me-1"></i>{{ test.moisture_content }}%
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-flask fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No recent quality tests</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quality Stats -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Quality Statistics
                    </h6>
                </div>
                <div class="card-body">
                    {% set approved_count = quality_tests | selectattr('approved', 'equalto', true) | list | length %}
                    {% set pending_count = vehicles | length %}
                    {% set total_tests = quality_tests | length %}

                    <div class="row text-center">
                        <div class="col-4">
                            <div class="border-end">
                                <h4 class="text-success mb-1">{{ approved_count }}</h4>
                                <small class="text-muted">Approved</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border-end">
                                <h4 class="text-warning mb-1">{{ pending_count }}</h4>
                                <small class="text-muted">Pending</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <h4 class="text-primary mb-1">{{ total_tests }}</h4>
                            <small class="text-muted">Total Tests</small>
                        </div>
                    </div>

                    {% if total_tests > 0 %}
                    <div class="mt-3">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success" style="width: {{ (approved_count / total_tests * 100)|round(1) }}%"></div>
                        </div>
                        <small class="text-muted">{{ ((approved_count / total_tests * 100)|round(1)) }}% approval rate</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quality Tests Table -->
    {% if quality_tests %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>All Quality Tests
                        </h5>
                        <div class="input-group" style="width: 300px;">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" placeholder="Search tests..." id="testSearch">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover data-table" id="testsTable">
                            <thead>
                                <tr>
                                    <th>Vehicle</th>
                                    <th>Supplier</th>
                                    <th>Test Details</th>
                                    <th>Category</th>
                                    <th>Instructor</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for test in quality_tests %}
                                <tr>
                                    <td>
                                        <strong>{{ test.vehicle.vehicle_number }}</strong>
                                        <br><small class="text-muted">
                                            {{ test.test_time.strftime('%d/%m/%Y %H:%M') }}
                                        </small>
                                    </td>
                                    <td>
                                        {% if test.vehicle.supplier %}
                                            {{ test.vehicle.supplier.company_name }}
                                        {% else %}
                                            <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>
                                            <i class="fas fa-vials me-1"></i>{{ test.sample_bags_tested }}/{{ test.total_bags }} bags<br>
                                            {% if test.moisture_content %}
                                                <i class="fas fa-tint me-1"></i>{{ test.moisture_content }}% moisture
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if test.category_assigned == 'Mill' else 'info' if test.category_assigned == 'HD' else 'warning' if test.category_assigned == 'Low Mill' else 'danger' }}">
                                            {{ test.category_assigned }}
                                        </span>
                                    </td>
                                    <td>{{ test.lab_instructor }}</td>
                                    <td>
                                        <span class="status-indicator status-{{ 'approved' if test.approved else 'pending' }}">
                                            {{ 'Approved' if test.approved else 'Pending Approval' }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="viewTestDetails({{ test.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if not test.approved %}
                                            <a href="{{ url_for('approve_vehicle', vehicle_id=test.vehicle_id) }}" class="btn btn-outline-success">
                                                <i class="fas fa-check"></i>
                                            </a>
                                            <a href="{{ url_for('reject_vehicle', vehicle_id=test.vehicle_id) }}" class="btn btn-outline-danger">
                                                <i class="fas fa-times"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Test Details Modal -->
<div class="modal fade" id="testDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quality Test Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="testDetailsContent">
                <!-- Content loaded via JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set current datetime for test date
    const testDate = document.getElementById('test_date');
    if (testDate && !testDate.value) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        testDate.value = now.toISOString().slice(0, 16);
    }

    // Initialize search functionality
    const searchInput = document.getElementById('testSearch');
    const table = document.getElementById('testsTable');

    if (searchInput && table) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }

    // Sample bag calculation
    const sampleBags = document.getElementById('sample_bags_tested');
    const totalBags = document.getElementById('total_bags');

    if (sampleBags && totalBags) {
        totalBags.addEventListener('input', function() {
            const total = parseInt(this.value);
            if (total > 0) {
                const suggestedSample = Math.min(Math.max(Math.ceil(total * 0.1), 1), 10);
                if (!sampleBags.value) {
                    sampleBags.value = suggestedSample;
                }
                sampleBags.max = Math.min(total, 50);
            }
        });
    }
});

// Load vehicle information
function loadVehicleInfo() {
    const vehicleSelect = document.getElementById('vehicle_id');
    const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
    const infoSection = document.getElementById('vehicleInfoSection');
    const infoContent = document.getElementById('vehicleInfoContent');

    if (selectedOption.value) {
        const vehicleNumber = selectedOption.dataset.number;
        const supplier = selectedOption.dataset.supplier;

        infoContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Vehicle Number:</strong> ${vehicleNumber}
                </div>
                <div class="col-md-6">
                    <strong>Supplier:</strong> ${supplier}
                </div>
            </div>
        `;
        infoSection.style.display = 'block';
    } else {
        infoSection.style.display = 'none';
    }
}

// View test details
function viewTestDetails(testId) {
    fetch(`/api/quality_test/${testId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('testDetailsContent').innerHTML = generateTestDetailsHTML(data);
            new bootstrap.Modal(document.getElementById('testDetailsModal')).show();
        })
        .catch(error => {
            showNotification('Error loading test details', 'danger');
            console.error('Error:', error);
        });
}

function generateTestDetailsHTML(test) {
    return `
        <div class="row">
            <div class="col-md-6">
                <h6>Vehicle & Test Information</h6>
                <table class="table table-sm">
                    <tr><th>Vehicle Number:</th><td>${test.vehicle_number}</td></tr>
                    <tr><th>Supplier:</th><td>${test.supplier_name || '-'}</td></tr>
                    <tr><th>Test Date:</th><td>${test.test_time}</td></tr>
                    <tr><th>Lab Instructor:</th><td>${test.lab_instructor}</td></tr>
                    <tr><th>Sample Tested:</th><td>${test.sample_bags_tested}/${test.total_bags} bags</td></tr>
                    <tr><th>Moisture Content:</th><td>${test.moisture_content ? test.moisture_content + '%' : '-'}</td></tr>
                    <tr><th>Foreign Matter:</th><td>${test.foreign_matter ? test.foreign_matter + '%' : '-'}</td></tr>
                    <tr><th>Broken Grains:</th><td>${test.broken_grains ? test.broken_grains + '%' : '-'}</td></tr>
                    <tr><th>Shrivelled & Broken:</th><td>${test.shrivelled_broken ? test.shrivelled_broken + '%' : '-'}</td></tr>
                    <tr><th>Damaged:</th><td>${test.damaged ? test.damaged + '%' : '-'}</td></tr>
                    <tr><th>Weevilled:</th><td>${test.weevilled ? test.weevilled + '%' : '-'}</td></tr>
                    <tr><th>Other Food Grains:</th><td>${test.other_food_grains ? test.other_food_grains + '%' : '-'}</td></tr>
                    <tr><th>Sprouted:</th><td>${test.sprouted ? test.sprouted + '%' : '-'}</td></tr>
                    <tr><th>Immature:</th><td>${test.immature ? test.immature + '%' : '-'}</td></tr>
                    <tr><th>Test Weight:</th><td>${test.test_weight ? test.test_weight + ' kg/hl' : '-'}</td></tr>
                    <tr><th>Gluten:</th><td>${test.gluten ? test.gluten + '%' : '-'}</td></tr>
                    <tr><th>Protein:</th><td>${test.protein ? test.protein + '%' : '-'}</td></tr>
                    <tr><th>Falling Number:</th><td>${test.falling_number ? test.falling_number + ' sec' : '-'}</td></tr>
                    <tr><th>Ash Content:</th><td>${test.ash_content ? test.ash_content + '%' : '-'}</td></tr>
                    <tr><th>Wet Gluten:</th><td>${test.wet_gluten ? test.wet_gluten + '%' : '-'}</td></tr>
                    <tr><th>Dry Gluten:</th><td>${test.dry_gluten ? test.dry_gluten + '%' : '-'}</td></tr>
                    <tr><th>Sedimentation Value:</th><td>${test.sedimentation_value ? test.sedimentation_value + ' ml' : '-'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Quality Assessment</h6>
                <table class="table table-sm">
                    <tr><th>Category:</th><td><span class="badge bg-primary">${test.category_assigned}</span></td></tr>
                    <tr><th>Status:</th><td><span class="badge ${test.approved ? 'bg-success' : 'bg-warning'}">${test.approved ? 'Approved' : 'Pending'}</span></td></tr>
                </table>
                ${test.quality_notes ? `<h6>Notes</h6><p>${test.quality_notes}</p>` : ''}
            </div>
        </div>
    `;
}
</script>
{% endblock %}