
{% extends "base.html" %}

{% block title %}Production Management Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">
                            <i class="fas fa-industry me-2 text-primary"></i>
                            Production Management Dashboard
                        </h3>
                        <div class="btn-group" role="group">
                            <a href="{{ url_for('production_orders') }}" class="btn btn-outline-primary">
                                <i class="fas fa-clipboard-list me-1"></i>Orders
                            </a>
                            <a href="{{ url_for('production_planning') }}" class="btn btn-outline-info">
                                <i class="fas fa-project-diagram me-1"></i>Planning
                            </a>
                            <a href="{{ url_for('production_execution') }}" class="btn btn-outline-success">
                                <i class="fas fa-play me-1"></i>Execution
                            </a>
                            <a href="{{ url_for('production_tracking') }}" class="btn btn-outline-warning">
                                <i class="fas fa-search me-1"></i>Tracking
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-clipboard-list fa-2x text-primary mb-2"></i>
                    <h4 class="card-title" id="totalOrders">{{ total_orders or 0 }}</h4>
                    <p class="card-text">Total Orders</p>
                    <a href="{{ url_for('production_orders') }}" class="btn btn-sm btn-primary">Manage</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-cogs fa-2x text-success mb-2"></i>
                    <h4 class="card-title" id="activeProductions">{{ active_productions or 0 }}</h4>
                    <p class="card-text">Active Productions</p>
                    <a href="{{ url_for('production_execution') }}" class="btn btn-sm btn-success">Monitor</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                    <h4 class="card-title" id="pendingPlans">{{ pending_plans or 0 }}</h4>
                    <p class="card-text">Pending Plans</p>
                    <a href="{{ url_for('production_planning') }}" class="btn btn-sm btn-warning">Plan</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-2x text-info mb-2"></i>
                    <h4 class="card-title" id="completedToday">{{ completed_today or 0 }}</h4>
                    <p class="card-text">Completed Today</p>
                    <a href="{{ url_for('production_tracking') }}" class="btn btn-sm btn-info">Track</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-primary btn-lg" onclick="showCreateOrderModal()">
                                    <i class="fas fa-plus me-2"></i>Create Production Order
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-success btn-lg" onclick="showStartProductionModal()">
                                    <i class="fas fa-play me-2"></i>Start Production
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-info btn-lg" onclick="showTrackingModal()">
                                    <i class="fas fa-search me-2"></i>Track Order
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Production Status -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-broadcast-tower me-2"></i>Live Production Status
                        <span class="badge bg-success ms-2" id="liveUpdateIndicator">Live</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="liveProductionContent">
                        <!-- Live production data will be loaded here -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading live production data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Alerts & Notifications
                    </h5>
                </div>
                <div class="card-body">
                    <div id="alertsContent">
                        <!-- Alerts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Orders and Production Timeline -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Recent Production Orders
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Product</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTable">
                                <!-- Recent orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-timeline me-2"></i>Production Timeline
                    </h5>
                </div>
                <div class="card-body">
                    <div id="productionTimeline">
                        <!-- Timeline will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Order Modal -->
<div class="modal fade" id="createOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Production Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('production_orders') }}" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Customer</label>
                                <input type="text" class="form-control" name="customer" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Product</label>
                                <input type="text" class="form-control" name="product" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Quantity (tons)</label>
                                <input type="number" step="0.1" class="form-control" name="quantity" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Deadline</label>
                                <input type="date" class="form-control" name="deadline" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-control" name="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Track Order Modal -->
<div class="modal fade" id="trackOrderModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Track Production Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="trackOrderNumber" 
                               placeholder="Enter order number (e.g., PO-20240101123456)">
                        <button class="btn btn-primary" onclick="trackOrderInModal()">
                            <i class="fas fa-search me-1"></i>Track
                        </button>
                    </div>
                </div>
                <div id="trackingResults">
                    <!-- Tracking results will be shown here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Start Production Modal -->
<div class="modal fade" id="startProductionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start Production</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Approved Production Plan</label>
                    <select class="form-control" id="approvedPlans">
                        <option value="">Loading plans...</option>
                    </select>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Only approved production plans can be started. Make sure planning is complete.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="startSelectedProduction()">
                    Start Production
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Dashboard initialization
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    loadLiveProduction();
    loadRecentOrders();
    
    // Auto-refresh every 30 seconds
    setInterval(function() {
        loadLiveProduction();
        updateStats();
    }, 30000);
});

// Load dashboard statistics
function loadDashboardData() {
    fetch('/api/dashboard_stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalOrders').textContent = data.stats.total_orders;
                document.getElementById('activeProductions').textContent = data.stats.active_productions;
                document.getElementById('pendingPlans').textContent = data.stats.pending_plans;
                document.getElementById('completedToday').textContent = data.stats.completed_today;
            }
        })
        .catch(error => console.error('Error loading dashboard stats:', error));
}

// Load live production data
function loadLiveProduction() {
    fetch('/api/active_processes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayLiveProduction(data.processes);
                updateLiveIndicator(data.processes.length > 0);
            }
        })
        .catch(error => {
            console.error('Error loading live production:', error);
            document.getElementById('liveProductionContent').innerHTML = 
                '<div class="alert alert-warning">Unable to load live production data</div>';
        });
}

function displayLiveProduction(processes) {
    const container = document.getElementById('liveProductionContent');
    
    if (processes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-pause-circle fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">No Active Productions</h6>
                <p class="text-muted">Start a new production to see live status here</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    processes.forEach(process => {
        html += `
            <div class="col-md-6 mb-3">
                <div class="card border-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title mb-1">${process.job_number}</h6>
                                <p class="card-text mb-1">
                                    <small class="text-muted">Order: ${process.order_number}</small><br>
                                    <small class="text-muted">Stage: ${process.stage}</small>
                                </p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${getStatusColor(process.status)}">${process.status}</span>
                                <div class="progress mt-1" style="width: 80px; height: 6px;">
                                    <div class="progress-bar" style="width: ${process.progress}%"></div>
                                </div>
                                <small>${process.progress}%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function updateLiveIndicator(isActive) {
    const indicator = document.getElementById('liveUpdateIndicator');
    if (isActive) {
        indicator.className = 'badge bg-success ms-2';
        indicator.textContent = 'Live';
    } else {
        indicator.className = 'badge bg-secondary ms-2';
        indicator.textContent = 'Idle';
    }
}

function getStatusColor(status) {
    switch(status) {
        case 'in_progress': return 'success';
        case 'pending': return 'warning';
        case 'completed': return 'primary';
        case 'paused': return 'secondary';
        default: return 'light';
    }
}

// Load recent orders
function loadRecentOrders() {
    fetch('/api/recent_orders')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayRecentOrders(data.orders);
            }
        })
        .catch(error => console.error('Error loading recent orders:', error));
}

function displayRecentOrders(orders) {
    const tbody = document.getElementById('recentOrdersTable');
    
    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent orders</td></tr>';
        return;
    }
    
    let html = '';
    orders.forEach(order => {
        html += `
            <tr>
                <td><strong>${order.order_number}</strong></td>
                <td>${order.product || 'N/A'}</td>
                <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="trackOrder('${order.order_number}')">
                        <i class="fas fa-search"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Modal functions
function showCreateOrderModal() {
    new bootstrap.Modal(document.getElementById('createOrderModal')).show();
}

function showStartProductionModal() {
    loadApprovedPlans();
    new bootstrap.Modal(document.getElementById('startProductionModal')).show();
}

function showTrackingModal() {
    new bootstrap.Modal(document.getElementById('trackOrderModal')).show();
}

function loadApprovedPlans() {
    const select = document.getElementById('approvedPlans');
    select.innerHTML = '<option value="">Loading...</option>';
    
    fetch('/api/approved_plans')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.plans.length > 0) {
                let html = '<option value="">Select a plan to start...</option>';
                data.plans.forEach(plan => {
                    html += `<option value="${plan.order_id}">${plan.order_number} - ${plan.product} (${plan.quantity} tons)</option>`;
                });
                select.innerHTML = html;
            } else {
                select.innerHTML = '<option value="">No approved plans available</option>';
            }
        })
        .catch(error => {
            console.error('Error loading plans:', error);
            select.innerHTML = '<option value="">Error loading plans</option>';
        });
}

function startSelectedProduction() {
    const orderId = document.getElementById('approvedPlans').value;
    if (!orderId) {
        alert('Please select a production plan to start');
        return;
    }
    
    // Redirect to start production execution
    window.location.href = `/start_production_execution/${orderId}`;
}

function trackOrder(orderNumber) {
    document.getElementById('trackOrderNumber').value = orderNumber;
    showTrackingModal();
    trackOrderInModal();
}

function trackOrderInModal() {
    const orderNumber = document.getElementById('trackOrderNumber').value.trim();
    if (!orderNumber) return;
    
    const resultsDiv = document.getElementById('trackingResults');
    resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
    
    fetch(`/api/order_tracking/${orderNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTrackingResults(data);
            } else {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
            }
        })
        .catch(error => {
            resultsDiv.innerHTML = '<div class="alert alert-danger">Error loading tracking data</div>';
        });
}

function displayTrackingResults(data) {
    const resultsDiv = document.getElementById('trackingResults');
    
    let html = `
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Order: ${data.order.order_number}</h6>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Customer:</strong> ${data.order.customer}</p>
                        <p><strong>Product:</strong> ${data.order.product}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Quantity:</strong> ${data.order.quantity} tons</p>
                        <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(data.order.status)}">${data.order.status}</span></p>
                    </div>
                </div>
    `;
    
    if (data.jobs && data.jobs.length > 0) {
        html += `
            <h6>Production Progress:</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Stage</th>
                            <th>Job Number</th>
                            <th>Status</th>
                            <th>Started</th>
                            <th>Completed</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.jobs.forEach(job => {
            html += `
                <tr>
                    <td><span class="badge bg-info">${job.stage.replace('_', ' ').toUpperCase()}</span></td>
                    <td>${job.job_number}</td>
                    <td><span class="badge bg-${getStatusColor(job.status)}">${job.status}</span></td>
                    <td>${job.started_at ? new Date(job.started_at).toLocaleString() : 'Not started'}</td>
                    <td>${job.completed_at ? new Date(job.completed_at).toLocaleString() : 'Not completed'}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
    }
    
    html += `
            </div>
        </div>
        <div class="mt-3">
            <a href="/order_tracking_detail/${data.order.order_number}" class="btn btn-primary" target="_blank">
                <i class="fas fa-external-link-alt me-1"></i>View Full Details
            </a>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
}

function updateStats() {
    loadDashboardData();
}
</script>

<style>
.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.progress {
    height: 6px;
}

.timeline-item {
    border-left: 2px solid #e9ecef;
    padding-left: 1rem;
    margin-bottom: 1rem;
}

.timeline-item:last-child {
    border-left: none;
}

#liveUpdateIndicator {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
</style>
{% endblock %}
