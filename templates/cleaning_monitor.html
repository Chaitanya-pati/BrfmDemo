{% extends "base.html" %}

{% block title %}Cleaning Monitor{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-eye me-2"></i>Cleaning Process Monitor</h2>
                <a href="{{ url_for('production_execution') }}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Execution
                </a>
            </div>
        </div>
    </div>

    <!-- Timer Display -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Cleaning Timer</h5>
                </div>
                <div class="card-body text-center">
                    <div id="timer-display" class="display-1 fw-bold mb-3" 
                         data-time-remaining="{{ time_remaining }}">
                        <span id="hours">00</span>:<span id="minutes">00</span>:<span id="seconds">00</span>
                    </div>
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar" role="progressbar" id="progress-bar" 
                             style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                    <div id="timer-status" class="alert alert-info">
                        {% if time_remaining > 0 %}
                        <i class="fas fa-play-circle me-2"></i>Cleaning process is running...
                        {% else %}
                        <i class="fas fa-check-circle me-2"></i>Cleaning process completed!
                        {% endif %}
                    </div>
                    
                    <!-- Reminder Alert for 12-hour process -->
                    <div id="reminder-alert" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-bell me-2"></i>
                        <strong>Reminder:</strong> Less than 1 hour remaining! Please prepare for completion.
                    </div>
                    {% if time_remaining <= 0 %}
                    <a href="{{ url_for('complete_cleaning', process_id=process.id) }}" 
                       class="btn btn-success btn-lg">
                        <i class="fas fa-check me-2"></i>Complete Cleaning Process
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Machine Cleaning Reminders and Timers -->
    {% if scheduled_cleanings or in_progress_cleanings %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Machine Cleaning Reminders</h5>
                </div>
                <div class="card-body">
                    <!-- Scheduled Machine Cleanings (Due Now) -->
                    {% if scheduled_cleanings %}
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-bell me-2"></i>Machine Cleaning Due!</h6>
                        {% for schedule in scheduled_cleanings %}
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <strong>{{ schedule.machine.name }}</strong> - {{ schedule.machine.location }}
                                <br><small class="text-muted">Due: {{ schedule.scheduled_time.strftime('%H:%M:%S') }}</small>
                            </div>
                            <a href="{{ url_for('process_machine_cleaning', job_id=schedule.job_id) }}#machine-{{ schedule.machine_id }}" 
                               class="btn btn-warning btn-sm">
                                <i class="fas fa-broom me-1"></i>Start Cleaning
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- In-Progress Machine Cleanings -->
                    {% if machine_cleaning_timers %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-clock me-2"></i>Active Machine Cleanings</h6>
                        {% for timer in machine_cleaning_timers %}
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <strong>{{ timer.log.machine.name }}</strong> - {{ timer.log.machine.location }}
                                <br><small class="text-muted">Cleaned by: {{ timer.log.cleaned_by }}</small>
                            </div>
                            <div class="text-end">
                                <div class="h5 mb-0" data-machine-timer="{{ timer.log.id }}" data-start-time="{{ timer.elapsed_time }}">
                                    <span class="badge bg-primary">
                                        <span class="timer-minutes">{{ "%02d"|format((timer.elapsed_time // 60)|int) }}</span>:
                                        <span class="timer-seconds">{{ "%02d"|format((timer.elapsed_time % 60)|int) }}</span>
                                    </span>
                                </div>
                                <small class="text-muted">Elapsed Time</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Process Information -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Process Details</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Job Number:</strong></td>
                            <td>{{ process.job.job_number }}</td>
                        </tr>
                        <tr>
                            <td><strong>Order Number:</strong></td>
                            <td>{{ process.job.order.order_number }}</td>
                        </tr>
                        <tr>
                            <td><strong>Process Type:</strong></td>
                            <td><span class="badge bg-info">{{ process.process_type }}</span></td>
                        </tr>
                        <tr>
                            <td><strong>Duration:</strong></td>
                            <td>{{ process.duration_hours }} hours</td>
                        </tr>
                        <tr>
                            <td><strong>Machine:</strong></td>
                            <td>{{ process.machine_name }}</td>
                        </tr>
                        <tr>
                            <td><strong>Operator:</strong></td>
                            <td>{{ process.operator_name }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Timeline</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Started:</strong></td>
                            <td>{{ process.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        </tr>
                        <tr>
                            <td><strong>Expected End:</strong></td>
                            <td>{{ process.end_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        </tr>
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>
                                {% if process.status == 'running' %}
                                <span class="badge bg-warning">{{ process.status }}</span>
                                {% elif process.status == 'completed' %}
                                <span class="badge bg-success">{{ process.status }}</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ process.status }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Cleaning Bin:</strong></td>
                            <td>{{ process.cleaning_bin.name }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let timeRemaining = {{ time_remaining }};
const totalDuration = {{ process.duration_hours * 3600 }};

function updateTimer() {
    const hours = Math.floor(timeRemaining / 3600);
    const minutes = Math.floor((timeRemaining % 3600) / 60);
    const seconds = Math.floor(timeRemaining % 60);
    
    document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
    document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
    document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
    
    // Update progress bar
    const progress = ((totalDuration - timeRemaining) / totalDuration) * 100;
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
    
    // Update status
    const statusDiv = document.getElementById('timer-status');
    if (timeRemaining <= 0) {
        statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>Cleaning process completed!';
        statusDiv.className = 'alert alert-success';
        
        // Show completion button
        if (!document.querySelector('.btn-success')) {
            statusDiv.insertAdjacentHTML('afterend', 
                '<a href="{{ url_for("complete_cleaning", process_id=process.id) }}" ' +
                'class="btn btn-success btn-lg mt-3">' +
                '<i class="fas fa-check me-2"></i>Complete Cleaning Process</a>'
            );
        }
        
        // Stop the timer
        clearInterval(timerInterval);
    } else {
        timeRemaining--;
    }
}

// Update timer every second
const timerInterval = setInterval(updateTimer, 1000);

// Initial update
updateTimer();

// Machine cleaning timers update
function updateMachineTimers() {
    const machineTimers = document.querySelectorAll('[data-machine-timer]');
    machineTimers.forEach(timer => {
        const startTime = parseFloat(timer.getAttribute('data-start-time'));
        const currentElapsed = startTime + (Date.now() - pageLoadTime) / 1000;
        
        const minutes = Math.floor(currentElapsed / 60);
        const seconds = Math.floor(currentElapsed % 60);
        
        timer.querySelector('.timer-minutes').textContent = minutes.toString().padStart(2, '0');
        timer.querySelector('.timer-seconds').textContent = seconds.toString().padStart(2, '0');
    });
}

// Track page load time for machine timer calculations
const pageLoadTime = Date.now();

// Update machine timers every second
setInterval(updateMachineTimers, 1000);

// Auto-refresh page data every 30 seconds
setInterval(function() {
    fetch('/api/cleaning_timer/{{ process.id }}')
        .then(response => response.json())
        .then(data => {
            timeRemaining = data.time_remaining;
            
            // Show reminder for 12-hour process
            const reminderAlert = document.getElementById('reminder-alert');
            if (data.show_reminder && data.process_type.includes('12h')) {
                reminderAlert.style.display = 'block';
                // Optional: Play sound or send notification
                if (Notification.permission === "granted") {
                    new Notification("Cleaning Process Reminder", {
                        body: "Less than 1 hour remaining in 12-hour cleaning process!",
                        icon: "/static/favicon.ico"
                    });
                }
            } else {
                reminderAlert.style.display = 'none';
            }
            
            if (data.can_complete && timeRemaining <= 0) {
                location.reload();
            }
        })
        .catch(error => console.error('Error fetching timer data:', error));
}, 30000);

// Check for new machine cleaning reminders every 30 seconds
setInterval(function() {
    // Reload page if there are new machine cleanings due
    fetch('/production_execution/cleaning_monitor/{{ process.id }}')
        .then(response => {
            if (response.ok) {
                // Check if page content has changed (simple approach)
                const currentReminders = document.querySelectorAll('.alert-warning').length;
                return response.text().then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newReminders = doc.querySelectorAll('.alert-warning').length;
                    if (newReminders > currentReminders) {
                        location.reload(); // Reload if new reminders appeared
                    }
                });
            }
        })
        .catch(error => console.error('Error checking for new reminders:', error));
}, 30000);

// Request notification permission
if ("Notification" in window) {
    Notification.requestPermission();
}
</script>
{% endblock %}