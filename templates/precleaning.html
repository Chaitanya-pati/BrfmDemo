{% extends "base.html" %}

{% block title %}Pre-cleaning Process - Wheat Processing Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="fas fa-filter me-2"></i>Pre-cleaning Process</h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-arrow-right me-2"></i>Transfer Wheat to Pre-cleaning</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="from_godown_id" class="form-label">From Godown</label>
                        <select class="form-select" id="from_godown_id" name="from_godown_id" required>
                            <option value="">Select Source Godown</option>
                            {% for godown in godowns %}
                            <option value="{{ godown.id }}" data-stock="{{ godown.current_stock }}">
                                {{ godown.name }} ({{ godown.godown_type.name }}) - {{ "%.1f"|format(godown.current_stock) }} kg available
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="to_precleaning_bin_id" class="form-label">To Pre-cleaning Bin</label>
                        <select class="form-select" id="to_precleaning_bin_id" name="to_precleaning_bin_id" required>
                            <option value="">Select Destination Bin</option>
                            {% for bin in precleaning_bins %}
                            <option value="{{ bin.id }}">
                                {{ bin.name }} - {{ "%.1f"|format(bin.current_stock) }}/{{ "%.0f"|format(bin.capacity) }} kg
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity to Transfer (kg)</label>
                        <input type="number" step="0.1" class="form-control" id="quantity" name="quantity" min="0.1" required>
                        <div class="form-text">Available stock: <span id="available-stock">0</span> kg</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="operator" class="form-label">Operator Name</label>
                        <input type="text" class="form-control" id="operator" name="operator" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="evidence_photo" class="form-label">Evidence Photo</label>
                        <input type="file" class="form-control" id="evidence_photo" name="evidence_photo" accept="image/*">
                        <div class="form-text">Upload photo of transfer process</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-exchange-alt me-2"></i>Execute Transfer
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Transfers</h5>
            </div>
            <div class="card-body">
                {% if transfers %}
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Qty (kg)</th>
                                    <th>Operator</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transfer in transfers %}
                                <tr>
                                    <td>{{ transfer.from_godown.name if transfer.from_godown else '-' }}</td>
                                    <td>{{ transfer.to_precleaning_bin.name if transfer.to_precleaning_bin else '-' }}</td>
                                    <td>{{ "%.1f"|format(transfer.quantity) }}</td>
                                    <td>{{ transfer.operator }}</td>
                                    <td>{{ transfer.transfer_time.strftime('%m/%d %H:%M') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No transfers recorded</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Pre-cleaning Equipment</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card bg-primary">
                            <div class="card-body text-center text-white">
                                <i class="fas fa-shield-alt fa-2x mb-2"></i>
                                <h6>Drum Shield</h6>
                                <small>Removes plastic, cotton string, thread</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-danger">
                            <div class="card-body text-center text-white">
                                <i class="fas fa-magnet fa-2x mb-2"></i>
                                <h6>Magnet Machine</h6>
                                <small>Removes metal particles</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-warning">
                            <div class="card-body text-center text-white">
                                <i class="fas fa-filter fa-2x mb-2"></i>
                                <h6>Separator</h6>
                                <small>Removes stones and debris</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <a href="{{ url_for('godown_management') }}" class="btn btn-outline-primary">
                        <i class="fas fa-tools me-2"></i>Manage Equipment Cleaning
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Pre-cleaning Bin Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for bin in precleaning_bins %}
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white text-center">
                                <h6 class="mb-0">{{ bin.name }}</h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-2">
                                    <h4 class="text-info">{{ "%.1f"|format(bin.current_stock) }} kg</h4>
                                    <small class="text-muted">of {{ "%.0f"|format(bin.capacity) }} kg capacity</small>
                                </div>
                                <div class="progress">
                                    {% set utilization = (bin.current_stock / bin.capacity * 100) if bin.capacity > 0 else 0 %}
                                    <div class="progress-bar bg-info" style="width: {{ utilization }}%">
                                        {{ "%.1f"|format(utilization) }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Update available stock when godown selection changes
document.getElementById('from_godown_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const stock = selectedOption.getAttribute('data-stock') || 0;
    document.getElementById('available-stock').textContent = parseFloat(stock).toFixed(1);
    
    // Update quantity max value
    const quantityInput = document.getElementById('quantity');
    quantityInput.max = stock;
});

// Validate quantity against available stock
document.getElementById('quantity').addEventListener('input', function() {
    const availableStock = parseFloat(document.getElementById('available-stock').textContent) || 0;
    const quantity = parseFloat(this.value) || 0;
    
    if (quantity > availableStock) {
        this.setCustomValidity('Quantity exceeds available stock');
        this.classList.add('is-invalid');
    } else {
        this.setCustomValidity('');
        this.classList.remove('is-invalid');
    }
});
</script>
{% endblock %}
