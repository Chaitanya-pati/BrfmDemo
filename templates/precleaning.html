{% extends "base.html" %}

{% block title %}Pre-cleaning Process - Wheat Processing Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="fas fa-filter me-2"></i>Pre-cleaning Process</h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-arrow-right me-2"></i>Transfer Wheat to Pre-cleaning</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="from_godown_id" class="form-label">From Godown</label>
                        <select class="form-select" id="from_godown_id" name="from_godown_id" required>
                            <option value="">Select Source Godown</option>
                            {% for godown in godowns %}
                            <option value="{{ godown.id }}" data-stock="{{ godown.current_stock }}">
                                {{ godown.name }} ({{ godown.godown_type.name }}) - {{ "%.1f"|format(godown.current_stock) }} kg available
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="to_precleaning_bin_id" class="form-label">To Pre-cleaning Bin</label>
                        <select class="form-select" id="to_precleaning_bin_id" name="to_precleaning_bin_id" required>
                            <option value="">Select Destination Bin</option>
                            {% for bin in precleaning_bins %}
                            <option value="{{ bin.id }}">
                                {{ bin.name }} - {{ "%.1f"|format(bin.current_stock) }}/{{ "%.0f"|format(bin.capacity) }} kg
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantity to Transfer (kg)</label>
                        <input type="number" step="0.1" class="form-control" id="quantity" name="quantity" min="0.1" required>
                        <div class="form-text">Available stock: <span id="available-stock">0</span> kg</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="operator" class="form-label">Operator Name</label>
                        <input type="text" class="form-control" id="operator" name="operator" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="evidence_photo" class="form-label">Evidence Photo</label>
                        <input type="file" class="form-control" id="evidence_photo" name="evidence_photo" accept="image/*">
                        <div class="form-text">Upload photo of transfer process</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                    
                    <input type="hidden" name="action" value="create_transfer">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>Create Transfer Record
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <!-- Pending Transfers (Ready to Start) -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Pending Transfers (Ready to Start)</h5>
            </div>
            <div class="card-body">
                {% if pending_transfers %}
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Qty (kg)</th>
                                    <th>Operator</th>
                                    <th>Time</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transfer in pending_transfers %}
                                <tr>
                                    <td>{{ transfer.from_godown.name if transfer.from_godown else '-' }}</td>
                                    <td>{{ transfer.to_precleaning_bin.name if transfer.to_precleaning_bin else '-' }}</td>
                                    <td>{{ "%.1f"|format(transfer.quantity) }}</td>
                                    <td>{{ transfer.operator }}</td>
                                    <td>{{ transfer.transfer_time.strftime('%m/%d %H:%M') }}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm" onclick="startPrecleaningTimer({{ transfer.id }})">
                                            <i class="fas fa-play me-1"></i>Start Transfer
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No pending transfers. Create a transfer record first.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Completed Transfers -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Transfers</h5>
            </div>
            <div class="card-body">
                {% if transfers %}
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Qty (kg)</th>
                                    <th>Operator</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transfer in transfers %}
                                <tr>
                                    <td>{{ transfer.from_godown.name if transfer.from_godown else '-' }}</td>
                                    <td>{{ transfer.to_precleaning_bin.name if transfer.to_precleaning_bin else '-' }}</td>
                                    <td>{{ "%.1f"|format(transfer.quantity) }}</td>
                                    <td>{{ transfer.operator }}</td>
                                    <td>{{ transfer.transfer_time.strftime('%m/%d %H:%M') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No transfers recorded</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Pre-cleaning Equipment</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card bg-primary">
                            <div class="card-body text-center text-white">
                                <i class="fas fa-shield-alt fa-2x mb-2"></i>
                                <h6>Drum Shield</h6>
                                <small>Removes plastic, cotton string, thread</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-danger">
                            <div class="card-body text-center text-white">
                                <i class="fas fa-magnet fa-2x mb-2"></i>
                                <h6>Magnet Machine</h6>
                                <small>Removes metal particles</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card bg-warning">
                            <div class="card-body text-center text-white">
                                <i class="fas fa-filter fa-2x mb-2"></i>
                                <h6>Separator</h6>
                                <small>Removes stones and debris</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <a href="{{ url_for('godown_management') }}" class="btn btn-outline-primary">
                        <i class="fas fa-tools me-2"></i>Manage Equipment Cleaning
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Pre-cleaning Bin Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for bin in precleaning_bins %}
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white text-center">
                                <h6 class="mb-0">{{ bin.name }}</h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-2">
                                    <h4 class="text-info">{{ "%.1f"|format(bin.current_stock) }} kg</h4>
                                    <small class="text-muted">of {{ "%.0f"|format(bin.capacity) }} kg capacity</small>
                                </div>
                                <div class="progress">
                                    {% set utilization = (bin.current_stock / bin.capacity * 100) if bin.capacity > 0 else 0 %}
                                    <div class="progress-bar bg-info" style="width: {{ utilization }}%">
                                        {{ "%.1f"|format(utilization) }}%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Active Processes Section -->
{% if active_processes %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Active Precleaning Processes</h5>
            </div>
            <div class="card-body">
                {% for process in active_processes %}
                <div class="card mb-3" id="process-card-{{ process.id }}">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            Process #{{ process.id }} - {{ process.operator }}
                            <span class="badge bg-success ms-2">RUNNING</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>From:</strong> {{ process.from_godown.name if process.from_godown else 'Unknown' }}</p>
                                <p><strong>To:</strong> {{ process.to_precleaning_bin.name if process.to_precleaning_bin else 'Unknown' }}</p>
                                <p><strong>Quantity:</strong> {{ "%.1f"|format(process.quantity) }} kg</p>
                            </div>
                            <div class="col-md-6">
                                <div class="timer-display text-center">
                                    <h4 class="text-primary" id="timer-{{ process.id }}">00:00:00</h4>
                                    <small class="text-muted">Process Runtime</small>
                                </div>
                                <div class="mt-3 text-center">
                                    <button class="btn btn-warning me-2" onclick="openPrecleaningManualCleaning({{ process.id }})">
                                        <i class="fas fa-camera me-1"></i>Log Manual Cleaning
                                    </button>
                                    <button class="btn btn-danger" onclick="stopPrecleaningProcess({{ process.id }})">
                                        <i class="fas fa-stop me-1"></i>Stop Process
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Manual Cleaning Status -->
                        <div class="mt-3">
                            <h6>Manual Cleaning Status (Every 30 seconds)</h6>
                            <div id="cleaning-status-{{ process.id }}" class="alert alert-info">
                                <small>Monitoring for manual cleaning reminders...</small>
                            </div>
                            <div id="cleaning-logs-{{ process.id }}">
                                <!-- Manual cleaning logs will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Manual Cleaning Modal for Precleaning -->
<div class="modal fade" id="precleaningManualCleaningModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Manual Cleaning - Precleaning Process</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="precleaningManualCleaningForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" id="precleaning_process_id" name="process_id">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Machine/Area Name *</label>
                                <input type="text" id="precleaning_machine_name" name="machine_name" 
                                       class="form-control" value="Precleaning Equipment" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Operator Name *</label>
                                <input type="text" id="precleaning_operator_name" name="operator_name" 
                                       class="form-control" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Before Cleaning Photo *</label>
                                <input type="file" name="photo_file" class="form-control" accept="image/*" required>
                                <input type="hidden" name="photo_type" value="before">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">After Cleaning Photo *</label>
                                <input type="file" name="photo_file_after" class="form-control" accept="image/*" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cleaning Notes (Optional)</label>
                        <textarea name="notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Log Manual Cleaning
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cleaning Reminder Modal for Precleaning -->
<div class="modal fade" id="precleaningReminderModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-warning">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-bell me-2"></i>Manual Cleaning Reminder - Precleaning
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="fas fa-broom fa-3x text-warning mb-3"></i>
                </div>
                <h6 class="text-primary">Time for Manual Machine Cleaning!</h6>
                <p class="mb-3">30-second interval <span id="precleaningReminderIntervalNumber">#</span> - Please perform manual cleaning</p>
                <div class="alert alert-info">
                    <small><i class="fas fa-info-circle me-1"></i>
                    Manual cleaning is required every 30 seconds during the precleaning process for optimal results.</small>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" onclick="openPrecleaningManualCleaningFromReminder()">
                    <i class="fas fa-camera me-1"></i>Log Cleaning Now
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Dismiss</button>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Update available stock when godown selection changes
document.getElementById('from_godown_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const stock = selectedOption.getAttribute('data-stock') || 0;
    document.getElementById('available-stock').textContent = parseFloat(stock).toFixed(1);
    
    // Update quantity max value
    const quantityInput = document.getElementById('quantity');
    quantityInput.max = stock;
});

// Validate quantity against available stock
document.getElementById('quantity').addEventListener('input', function() {
    const availableStock = parseFloat(document.getElementById('available-stock').textContent) || 0;
    const quantity = parseFloat(this.value) || 0;
    
    if (quantity > availableStock) {
        this.setCustomValidity('Quantity exceeds available stock');
        this.classList.add('is-invalid');
    } else {
        this.setCustomValidity('');
        this.classList.remove('is-invalid');
    }
});

// Precleaning process management
let precleaningTimers = {};
let precleaningReminderIntervals = {};
let currentPrecleaningProcessId = null;

// Start timer for active processes
{% for process in active_processes %}
startPrecleaningTimer({{ process.id }});
{% endfor %}

function startPrecleaningTimer(processId) {
    // Clear any existing timer first
    if (precleaningTimers[processId]) {
        clearInterval(precleaningTimers[processId]);
        delete precleaningTimers[processId];
    }
    
    precleaningTimers[processId] = setInterval(() => {
        fetch(`/api/precleaning_timer_status/${processId}`)
            .then(response => response.json())
            .then(data => {
                if (data.timer_active) {
                    updatePrecleaningTimerDisplay(processId, data.elapsed_seconds);
                    
                    // Check for manual cleaning reminders every 30 seconds
                    if (data.needs_manual_cleaning) {
                        checkPrecleaningReminders(processId);
                    }
                } else {
                    // Timer is not active, clear interval and hide process card
                    clearInterval(precleaningTimers[processId]);
                    delete precleaningTimers[processId];
                    
                    if (precleaningReminderIntervals[processId]) {
                        clearInterval(precleaningReminderIntervals[processId]);
                        delete precleaningReminderIntervals[processId];
                    }
                    
                    // Hide the process card
                    const processCard = document.getElementById(`process-card-${processId}`);
                    if (processCard) {
                        processCard.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching timer status:', error);
                // Clear timer on error to prevent endless requests
                clearInterval(precleaningTimers[processId]);
                delete precleaningTimers[processId];
            });
    }, 1000);
    
    // Start reminder checking
    startPrecleaningReminderChecking(processId);
}

function updatePrecleaningTimerDisplay(processId, elapsedSeconds) {
    const hours = Math.floor(elapsedSeconds / 3600);
    const minutes = Math.floor((elapsedSeconds % 3600) / 60);
    const seconds = elapsedSeconds % 60;
    
    const timerDisplay = document.getElementById(`timer-${processId}`);
    if (timerDisplay) {
        timerDisplay.textContent = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

function startPrecleaningReminderChecking(processId) {
    // Clear any existing reminder interval first
    if (precleaningReminderIntervals[processId]) {
        clearInterval(precleaningReminderIntervals[processId]);
        delete precleaningReminderIntervals[processId];
    }
    
    precleaningReminderIntervals[processId] = setInterval(() => {
        // Check if the main timer is still active before checking reminders
        if (precleaningTimers[processId]) {
            checkPrecleaningReminders(processId);
        } else {
            // Clear reminder interval if main timer is not active
            clearInterval(precleaningReminderIntervals[processId]);
            delete precleaningReminderIntervals[processId];
        }
    }, 30000); // Check every 30 seconds
}

function checkPrecleaningReminders(processId) {
    fetch(`/api/get_precleaning_pending_reminders/${processId}`)
        .then(response => response.json())
        .then(data => {
            if (data.has_pending && data.show_popup) {
                showPrecleaningReminderModal(data.reminder);
            }
        })
        .catch(error => console.error('Error checking reminders:', error));
}

function showPrecleaningReminderModal(reminder) {
    currentPrecleaningProcessId = reminder.process_id;
    document.getElementById('precleaningReminderIntervalNumber').textContent = reminder.sequence;
    
    const modal = new bootstrap.Modal(document.getElementById('precleaningReminderModal'));
    modal.show();
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        modal.hide();
    }, 5000);
}

function openPrecleaningManualCleaning(processId) {
    currentPrecleaningProcessId = processId;
    document.getElementById('precleaning_process_id').value = processId;
    
    const modal = new bootstrap.Modal(document.getElementById('precleaningManualCleaningModal'));
    modal.show();
}

function openPrecleaningManualCleaningFromReminder() {
    // Close reminder modal
    const reminderModal = bootstrap.Modal.getInstance(document.getElementById('precleaningReminderModal'));
    if (reminderModal) reminderModal.hide();
    
    // Open manual cleaning modal
    openPrecleaningManualCleaning(currentPrecleaningProcessId);
}

function startPrecleaningTimer(transferId) {
    if (confirm('Start precleaning timer for this transfer?')) {
        fetch(`/start_precleaning_timer/${transferId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Reload page to show the active process
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error starting timer:', error);
            alert('Error starting timer');
        });
    }
}

function stopPrecleaningProcess(processId) {
    if (confirm('Are you sure you want to stop this precleaning process? This will complete the inventory transfer.')) {
        // Clear timers immediately to prevent continued updates
        if (precleaningTimers[processId]) {
            clearInterval(precleaningTimers[processId]);
            delete precleaningTimers[processId];
        }
        if (precleaningReminderIntervals[processId]) {
            clearInterval(precleaningReminderIntervals[processId]);
            delete precleaningReminderIntervals[processId];
        }
        
        fetch(`/stop_precleaning/${processId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                
                // Hide the process card immediately
                const processCard = document.getElementById(`process-card-${processId}`);
                if (processCard) {
                    processCard.style.display = 'none';
                }
                
                // Reload page to update the view after a short delay
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('Error: ' + data.error);
                // Restart timers if there was an error
                startPrecleaningTimer(processId);
            }
        })
        .catch(error => {
            console.error('Error stopping process:', error);
            alert('Error stopping process');
            // Restart timers if there was an error
            startPrecleaningTimer(processId);
        });
    }
}

// Handle manual cleaning form submission
document.getElementById('precleaningManualCleaningForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const processId = formData.get('process_id');
    
    // Upload before photo
    fetch('/upload_precleaning_cleaning_photo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Now upload after photo
            const afterFormData = new FormData();
            afterFormData.append('process_id', processId);
            afterFormData.append('photo_type', 'after');
            afterFormData.append('operator_name', formData.get('operator_name'));
            afterFormData.append('notes', formData.get('notes'));
            afterFormData.append('photo_file', formData.get('photo_file_after'));
            
            return fetch('/upload_precleaning_cleaning_photo', {
                method: 'POST',
                body: afterFormData
            });
        } else {
            throw new Error(data.error);
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Manual cleaning logged successfully!');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('precleaningManualCleaningModal'));
            if (modal) modal.hide();
            
            // Reset form
            this.reset();
            
            // Update cleaning logs
            loadPrecleaningManualCleanings(processId);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error logging manual cleaning: ' + error.message);
    });
});

function loadPrecleaningManualCleanings(processId) {
    fetch(`/get_precleaning_manual_cleanings/${processId}`)
        .then(response => response.json())
        .then(data => {
            const logsContainer = document.getElementById(`cleaning-logs-${processId}`);
            if (logsContainer && data.manual_cleanings) {
                const logsHtml = data.manual_cleanings.slice(0, 3).map(cleaning => `
                    <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                        <small class="text-muted">
                            ${new Date(cleaning.cleaning_time).toLocaleTimeString()} - ${cleaning.operator_name}
                        </small>
                        <span class="badge bg-success">Completed</span>
                    </div>
                `).join('');
                
                logsContainer.innerHTML = `
                    <h6 class="mt-2">Recent Manual Cleanings (${data.total_manual_cleanings} total)</h6>
                    ${logsHtml || '<small class="text-muted">No manual cleanings logged yet</small>'}
                `;
            }
        })
        .catch(error => console.error('Error loading manual cleanings:', error));
}

// Load manual cleanings for active processes
{% for process in active_processes %}
loadPrecleaningManualCleanings({{ process.id }});
{% endfor %}
</script>
{% endblock %}
