{% extends "base.html" %}

{% block title %}Storage Management{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-warehouse me-2"></i>Storage Area Management
                        </h4>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#transferModal">
                                <i class="fas fa-exchange-alt me-1"></i>Transfer Stock
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Storage Areas Overview -->
    <div class="row mb-4">
        {% for area in storage_areas %}
        <div class="col-md-3 mb-3">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">{{ area.name }}</h6>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        {% set usage_percentage = (area.current_stock_kg / area.capacity_kg * 100) if area.capacity_kg > 0 else 0 %}
                        <div class="progress mb-2" style="height: 20px;">
                            {% if usage_percentage < 70 %}
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ usage_percentage }}%">
                                {{ "%.1f"|format(usage_percentage) }}%
                            </div>
                            {% elif usage_percentage < 90 %}
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ usage_percentage }}%">
                                {{ "%.1f"|format(usage_percentage) }}%
                            </div>
                            {% else %}
                            <div class="progress-bar bg-danger" role="progressbar" style="width: {{ usage_percentage }}%">
                                {{ "%.1f"|format(usage_percentage) }}%
                            </div>
                            {% endif %}
                        </div>
                        <small class="text-muted">{{ "%.1f"|format(area.current_stock_kg) }} / {{ area.capacity_kg }} kg</small>
                    </div>
                    <div class="row text-center">
                        <div class="col-6">
                            <h6 class="text-primary">{{ "%.1f"|format(area.current_stock_kg) }}kg</h6>
                            <small class="text-muted">Current Stock</small>
                        </div>
                        <div class="col-6">
                            <h6 class="text-success">{{ "%.1f"|format(area.capacity_kg - area.current_stock_kg) }}kg</h6>
                            <small class="text-muted">Available</small>
                        </div>
                    </div>
                    {% if area.location %}
                    <div class="mt-2">
                        <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i>{{ area.location }}</small>
                    </div>
                    {% endif %}
                    <div class="mt-3">
                        <button class="btn btn-outline-primary btn-sm w-100" 
                                onclick="showStorageDetails({{ area.id }}, '{{ area.name }}')">
                            <i class="fas fa-info-circle me-1"></i>View Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Storage Details Modal -->
    <div class="modal fade" id="storageDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>Storage Area Details - <span id="storageAreaName"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="storageDetailsContent">
                        <div class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading storage details...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Stock Modal -->
    <div class="modal fade" id="transferModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Transfer Stock Between Storage Areas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST">
                    <input type="hidden" name="action" value="transfer_storage">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">From Storage Area *</label>
                                    <select name="from_storage_id" id="fromStorage" class="form-select" required onchange="loadAvailableProducts()">
                                        <option value="">Select source storage...</option>
                                        {% for area in storage_areas %}
                                        {% if area.current_stock_kg > 0 %}
                                        <option value="{{ area.id }}" data-stock="{{ area.current_stock_kg }}">{{ area.name }} ({{ "%.1f"|format(area.current_stock_kg) }}kg available)</option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted" id="fromStorageInfo">Select a storage area with available stock</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">To Storage Area *</label>
                                    <select name="to_storage_id" id="toStorage" class="form-select" required onchange="updateToStorageInfo()">
                                        <option value="">Select destination storage...</option>
                                        {% for area in storage_areas %}
                                        <option value="{{ area.id }}" data-available="{{ area.capacity_kg - area.current_stock_kg }}">{{ area.name }} ({{ "%.1f"|format(area.capacity_kg - area.current_stock_kg) }}kg capacity available)</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted" id="toStorageInfo">Select destination storage area</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dynamic Product Selection Section -->
                        <div class="row" id="productSelectionSection" style="display: none;">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Available Products in Source Storage *</label>
                                    <select name="product_bag_type" id="productBagSelect" class="form-select" required onchange="updateTransferFields()">
                                        <option value="">Select product and bag type...</option>
                                    </select>
                                    <small class="form-text text-muted" id="productInfo">Select a source storage area first to see available products</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transfer Quantity Section -->
                        <div class="row" id="quantitySection" style="display: none;">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Number of Bags *</label>
                                    <input type="number" name="bag_count" id="bagCount" class="form-control" min="1" required onchange="calculateTransferWeight()">
                                    <small class="form-text text-muted" id="bagCountInfo">Enter number of bags to transfer</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Weight per Bag (kg)</label>
                                    <input type="number" name="weight_per_bag" id="weightPerBag" class="form-control" readonly>
                                    <small class="form-text text-muted">Automatically filled based on selection</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Total Weight (kg) *</label>
                                    <input type="number" name="total_weight" id="totalWeight" class="form-control" readonly>
                                    <small class="form-text text-muted" id="totalWeightInfo">Calculated automatically</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden fields for backend processing -->
                        <input type="hidden" name="product_name" id="hiddenProductName">
                        <input type="hidden" name="quantity" id="hiddenQuantity">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Operator Name *</label>
                                    <input type="text" name="operator_name" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Transfer Reason</label>
                                    <select class="form-select" name="reason">
                                        <option value="">Select reason...</option>
                                        <option value="space_optimization">Space Optimization</option>
                                        <option value="quality_segregation">Quality Segregation</option>
                                        <option value="maintenance">Storage Area Maintenance</option>
                                        <option value="order_preparation">Order Preparation</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Enhanced Transfer System:</strong>
                            <ul class="mb-0 mt-2">
                                <li><strong>Step 1:</strong> Select source storage to see available products with bag information</li>
                                <li><strong>Step 2:</strong> Choose product and bag type (e.g., "Maida (25kg bags) - 50 bags available")</li>
                                <li><strong>Step 3:</strong> Enter number of bags to transfer - weight calculates automatically</li>
                                <li><strong>Step 4:</strong> Select destination storage and complete transfer</li>
                                <li>Physical movement should be completed before confirming transfer</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-exchange-alt me-1"></i>Execute Transfer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Recent Transfers -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Storage Transfers</h5>
                </div>
                <div class="card-body">
                    {% if recent_transfers %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Product</th>
                                    <th>From Storage</th>
                                    <th>To Storage</th>
                                    <th>Quantity</th>
                                    <th>Operator</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transfer in recent_transfers %}
                                <tr>
                                    <td>{{ transfer.transfer_time.strftime('%d/%m/%Y %H:%M') }}</td>
                                    <td>{{ transfer.product.name }}</td>
                                    <td>{{ transfer.from_storage.name }}</td>
                                    <td>{{ transfer.to_storage.name }}</td>
                                    <td>{{ transfer.quantity_kg }}kg</td>
                                    <td>{{ transfer.operator_name }}</td>
                                    <td>{{ transfer.reason or 'Not specified' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">No storage transfers recorded yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateFromStorageInfo() {
    const select = document.getElementById('fromStorage');
    const info = document.getElementById('fromStorageInfo');
    const quantityInput = document.getElementById('transferQuantity');
    
    if (select.value) {
        const selectedOption = select.options[select.selectedIndex];
        const availableStock = parseFloat(selectedOption.dataset.stock || 0);
        info.textContent = `Available stock: ${availableStock.toFixed(2)}kg`;
        quantityInput.max = availableStock;
    } else {
        info.textContent = 'Select a storage area with available stock';
        quantityInput.removeAttribute('max');
    }
}

function updateToStorageInfo() {
    const select = document.getElementById('toStorage');
    const info = document.getElementById('toStorageInfo');
    
    if (select.value) {
        const selectedOption = select.options[select.selectedIndex];
        const availableCapacity = parseFloat(selectedOption.dataset.available || 0);
        info.textContent = `Available capacity: ${availableCapacity.toFixed(2)}kg`;
    } else {
        info.textContent = 'Select destination storage area';
    }
}

// Enhanced transfer functionality for dynamic product loading
function loadAvailableProducts() {
    const fromStorageSelect = document.getElementById('fromStorage');
    const productSection = document.getElementById('productSelectionSection');
    const productSelect = document.getElementById('productBagSelect');
    const productInfo = document.getElementById('productInfo');
    const quantitySection = document.getElementById('quantitySection');
    
    // Reset sections
    productSection.style.display = 'none';
    quantitySection.style.display = 'none';
    productSelect.innerHTML = '<option value="">Loading available products...</option>';
    
    if (!fromStorageSelect.value) {
        productInfo.textContent = 'Select a source storage area first to see available products';
        updateFromStorageInfo();
        return;
    }
    
    // Update storage info
    updateFromStorageInfo();
    
    // Load available products via API
    fetch(`/api/storage_area_stock/${fromStorageSelect.value}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.available_products.length > 0) {
                productSection.style.display = 'block';
                productSelect.innerHTML = '<option value="">Select product and bag type...</option>';
                
                data.available_products.forEach(product => {
                    product.bag_types.forEach(bagType => {
                        const optionValue = JSON.stringify({
                            product_name: product.product_name,
                            bag_type: bagType.bag_type,
                            weight_per_bag: bagType.weight_per_bag,
                            available_bags: bagType.available_bags
                        });
                        
                        const option = document.createElement('option');
                        option.value = optionValue;
                        option.textContent = bagType.display_text;
                        productSelect.appendChild(option);
                    });
                });
                
                productInfo.textContent = `Found ${data.available_products.length} products with available stock`;
            } else {
                productSection.style.display = 'block';
                productSelect.innerHTML = '<option value="">No products available in this storage area</option>';
                productInfo.textContent = 'No products found with available stock in this storage area';
            }
        })
        .catch(error => {
            console.error('Error loading products:', error);
            productSection.style.display = 'block';
            productSelect.innerHTML = '<option value="">Error loading products</option>';
            productInfo.textContent = 'Error loading products. Please try again.';
        });
}

function updateTransferFields() {
    const productSelect = document.getElementById('productBagSelect');
    const quantitySection = document.getElementById('quantitySection');
    const bagCountInput = document.getElementById('bagCount');
    const weightPerBagInput = document.getElementById('weightPerBag');
    const bagCountInfo = document.getElementById('bagCountInfo');
    
    if (!productSelect.value) {
        quantitySection.style.display = 'none';
        return;
    }
    
    try {
        const productData = JSON.parse(productSelect.value);
        
        // Show quantity section and populate fields
        quantitySection.style.display = 'block';
        weightPerBagInput.value = productData.weight_per_bag;
        bagCountInput.max = productData.available_bags;
        bagCountInput.value = '';
        
        // Update hidden fields
        document.getElementById('hiddenProductName').value = productData.product_name;
        
        // Update info text
        bagCountInfo.textContent = `Available: ${productData.available_bags} bags (max)`;
        
        // Clear total weight
        document.getElementById('totalWeight').value = '';
        document.getElementById('hiddenQuantity').value = '';
        
    } catch (error) {
        console.error('Error parsing product data:', error);
        quantitySection.style.display = 'none';
    }
}

function calculateTransferWeight() {
    const bagCountInput = document.getElementById('bagCount');
    const weightPerBagInput = document.getElementById('weightPerBag');
    const totalWeightInput = document.getElementById('totalWeight');
    const hiddenQuantityInput = document.getElementById('hiddenQuantity');
    const totalWeightInfo = document.getElementById('totalWeightInfo');
    
    const bagCount = parseInt(bagCountInput.value) || 0;
    const weightPerBag = parseFloat(weightPerBagInput.value) || 0;
    const totalWeight = bagCount * weightPerBag;
    
    totalWeightInput.value = totalWeight.toFixed(2);
    hiddenQuantityInput.value = totalWeight.toFixed(2);
    
    if (bagCount > 0) {
        totalWeightInfo.textContent = `${bagCount} bags Ã— ${weightPerBag}kg = ${totalWeight.toFixed(2)}kg total`;
    } else {
        totalWeightInfo.textContent = 'Calculated automatically';
    }
}

// Enhanced form validation for bag-based transfers
document.querySelector('#transferModal form').addEventListener('submit', function(e) {
    const fromStorage = document.getElementById('fromStorage').value;
    const toStorage = document.getElementById('toStorage').value;
    const productBagSelect = document.getElementById('productBagSelect').value;
    const bagCount = parseInt(document.getElementById('bagCount').value) || 0;
    const quantity = parseFloat(document.getElementById('hiddenQuantity').value) || 0;
    
    // Basic validation
    if (!fromStorage) {
        alert('Please select a source storage area!');
        e.preventDefault();
        return;
    }
    
    if (!toStorage) {
        alert('Please select a destination storage area!');
        e.preventDefault();
        return;
    }
    
    if (!productBagSelect) {
        alert('Please select a product and bag type to transfer!');
        e.preventDefault();
        return;
    }
    
    if (bagCount <= 0) {
        alert('Please enter a valid number of bags to transfer!');
        e.preventDefault();
        return;
    }
    
    if (fromStorage === toStorage) {
        alert('Source and destination storage areas cannot be the same!');
        e.preventDefault();
        return;
    }
    
    // Validate against available stock and capacity
    try {
        const productData = JSON.parse(productBagSelect);
        
        if (bagCount > productData.available_bags) {
            alert(`Cannot transfer ${bagCount} bags. Only ${productData.available_bags} bags available!`);
            e.preventDefault();
            return;
        }
        
        // Check destination capacity
        const toOption = document.querySelector(`#toStorage option[value="${toStorage}"]`);
        if (toOption) {
            const availableCapacity = parseFloat(toOption.dataset.available || 0);
            
            if (quantity > availableCapacity) {
                if (!confirm(`Transfer quantity (${quantity}kg) exceeds available capacity (${availableCapacity}kg). This may cause overflow. Continue?`)) {
                    e.preventDefault();
                    return;
                }
            }
        }
        
        // Final confirmation
        const confirmMessage = `Confirm transfer:\n\n` +
            `Product: ${productData.product_name}\n` +
            `Quantity: ${bagCount} bags (${productData.bag_type})\n` +
            `Total Weight: ${quantity}kg\n` +
            `From: ${document.querySelector('#fromStorage option:checked').textContent}\n` +
            `To: ${document.querySelector('#toStorage option:checked').textContent}\n\n` +
            `Proceed with transfer?`;
        
        if (!confirm(confirmMessage)) {
            e.preventDefault();
            return;
        }
        
    } catch (error) {
        console.error('Validation error:', error);
        alert('Invalid product selection. Please try again.');
        e.preventDefault();
        return;
    }
});

// Storage details functionality
function showStorageDetails(storageAreaId, storageAreaName) {
    document.getElementById('storageAreaName').textContent = storageAreaName;
    const modal = new bootstrap.Modal(document.getElementById('storageDetailsModal'));
    modal.show();
    
    // Load storage details via AJAX
    fetch(`/api/storage_details/${storageAreaId}`)
        .then(response => response.json())
        .then(data => {
            displayStorageDetails(data);
        })
        .catch(error => {
            console.error('Error loading storage details:', error);
            document.getElementById('storageDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading storage details. Please try again.
                </div>
            `;
        });
}

function displayStorageDetails(data) {
    const content = document.getElementById('storageDetailsContent');
    
    if (!data.products || data.products.length === 0) {
        content.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Products Stored</h5>
                <p class="text-muted">This storage area is currently empty.</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="text-primary">${data.total_quantity.toFixed(2)} kg</h5>
                        <small class="text-muted">Total Stored</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="text-success">${data.total_bags}</h5>
                        <small class="text-muted">Total Bags</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="text-info">${data.products.length}</h5>
                        <small class="text-muted">Product Types</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="text-warning">${data.utilization.toFixed(1)}%</h5>
                        <small class="text-muted">Utilization</small>
                    </div>
                </div>
            </div>
        </div>
        
        <h6 class="mb-3"><i class="fas fa-boxes me-2"></i>Products Breakdown</h6>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Product Name</th>
                        <th>Total Quantity</th>
                        <th>Bag Details</th>
                        <th>Last Updated</th>
                        <th>Packed By</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.products.forEach(product => {
        html += `
            <tr>
                <td>
                    <strong>${product.name}</strong>
                    <br><small class="text-muted">${product.category}</small>
                </td>
                <td>
                    <span class="badge bg-primary">${product.total_quantity.toFixed(2)} kg</span>
                </td>
                <td>
        `;
        
        // Group bags by weight for better display
        const bagGroups = {};
        product.bag_details.forEach(bag => {
            const weight = bag.bag_weight_kg;
            if (!bagGroups[weight]) {
                bagGroups[weight] = { count: 0, total_kg: 0 };
            }
            bagGroups[weight].count += bag.number_of_bags;
            bagGroups[weight].total_kg += bag.total_packed_kg;
        });
        
        Object.keys(bagGroups).forEach(weight => {
            const group = bagGroups[weight];
            html += `
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span>${weight}kg bags:</span>
                    <span class="badge bg-secondary">${group.count} bags (${group.total_kg.toFixed(2)}kg)</span>
                </div>
            `;
        });
        
        if (product.shallow_storage > 0) {
            html += `
                <div class="d-flex justify-content-between align-items-center">
                    <span>Shallow storage:</span>
                    <span class="badge bg-info">${product.shallow_storage.toFixed(2)} kg</span>
                </div>
            `;
        }
        
        html += `
                </td>
                <td>${product.last_updated}</td>
                <td>${product.operators.join(', ')}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    if (data.recent_activities && data.recent_activities.length > 0) {
        html += `
            <h6 class="mb-3 mt-4"><i class="fas fa-history me-2"></i>Recent Activities</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Activity</th>
                            <th>Quantity</th>
                            <th>Operator</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.recent_activities.forEach(activity => {
            html += `
                <tr>
                    <td>${activity.date_time}</td>
                    <td>${activity.activity_type}</td>
                    <td>${activity.quantity} kg</td>
                    <td>${activity.operator}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
    }
    
    content.innerHTML = html;
}

// Auto-refresh every 5 minutes to keep storage info updated
setInterval(function() {
    location.reload();
}, 300000);
</script>
{% endblock %}